<span>Purchase <%= @tickets.count %> tickets for <%= number_to_currency(@amount, unit:"$") %></span>
<br>
<% if user_signed_in? %>

Logged in as <%= current_user.email %>.
<br>
Not <%= current_user.email %>? <%= link_to  "Sign Out", destroy_user_session_path, method: "delete" %>.
<br>
<%= render 'sales/checkout_form', :object_path => board_show_checkout_path(@board, @show), :sale => @sale, :amount => @amount, :coupon => @coupon %>

<% else %>
Have an account?
<br>
<%= link_to 'Log in and Purchase', new_user_session_path(:reserve_code => @reserve_code) %>
<br><br>
Don't have an account?
<%= link_to 'Register and purchase', new_user_registration_path(:reserve_code => @reserve_code) %>
<br>
or continue and purchase as a guest
<br>
<br>

  <script src="https://checkout.stripe.com/v2/checkout.js"></script>

  <button id="stripeButton">Purchase</button>
  <div class="row">
    <div id="payment-errors" class="alert" style="<%= sale.errors.any? ? '' : 'display: none;' %>">
      <% sale.errors.full_messages.each do |msg| %>
        <span><%= msg %></span>
      <% end %>
    </div>
  </div>

<script>  
  $(function(){
    var stripeButton = $('#stripeButton');
    console.log(stripeButton);
    console.log(<%= @amount.to_i * 100 %>);

    $('#stripeButton').click(function(){
      var token = function(res){
        var $input = $('<input type=hidden name=stripeToken />').val(res.id);
        $('form').append($input);
        console.log(res)
        console.log(res.email)
        $.ajax({
          type: "POST",
          url: "<%= board_show_checkout_path(@board, @show) %>",
          data: { reserve_code: "<%= @reserve_code %>",
                  stripeToken: res.id,
                  name: res.card.name,
                  email: res.email }, // TODO - clean this up to only send a js plainObject with the necessary data
          success: function(data) { poll(data.guid, 60) },
          error: function(data) { showError(data.responseJSON.error) }
        });
      };

      StripeCheckout.open({
        key:         '<%= ENV["STRIPE_TEST_KEY_PUBLISHABLE"] %>', // TODO - replace with live key in production
        address:     true,
        amount:      '<%= @amount.to_i * 100 %>',
        currency:    'usd',
        name:        'Showboarder',
        description: "<%= @tickets.count%> tickets (<%= number_to_currency(@amount, unit:"$") %>)",
        panelLabel:  'Checkout',
        token:       token
      });

      return false;
    });

    function showError(error) {
      var form = $('#payment-form');
      $('#payment-errors').html(error);
      $('#payment-errors').show();
      // $('#pay-button').show();
      // $('#spinner-button').hide();
    }

    function poll(guid, num_retries_left) {
      console.log("Polling...");
      if (num_retries_left == 0) {
        showError("This seems to be taking too long. Email <a href=\"contact@showboarder.com\">contact@showboarder.com</a> and reference sale <strong>" + guid );
        return;
      }
      $.get("/status/" + guid, function(data) {

        if (data.status === "finished") {
          window.location = "/confirm/" + guid;
        } else if (data.status === "errored") {
          showError(data.error)
        } else {
          setTimeout(function() { poll(guid, num_retries_left - 1) }, 500);
        }
      });
    }

  });
</script>

<% end %>