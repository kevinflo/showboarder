<script src="https://checkout.stripe.com/v2/checkout.js"></script>

<script>
  $(function(){
    var amountProduct = $('#amount-product');
    var amountSb = $('#amount-sb');
    var amountCharity = $('#amount-charity');
    var amountTotal = $('#amount-total');

    var totalCalculator = function() {
      return parseInt(amountSb.val()) + parseInt(amountCharity.val()) + parseInt(amountProduct.val())
    }

    var totalFill = function(){
      amountTotal.html("$" + totalCalculator().toString() + ".00");  
    }

    amountProduct.change(function(){
      totalFill();
    });

    amountSb.change(function(){
      totalFill();
    });

    amountCharity.change(function(){
      totalFill();
    });

    totalFill();

    $('#stripeButton').click(function(){
      var token = function(res){
        var $input = $('<input type=hidden name=stripeToken />').val(res.id);
        $('form').append($input);
        console.log(res)
        console.log(res.email)
        $.ajax({
          type: "POST",
          url: "<%= board_show_checkout_path(@board, @show) %>",
          data: { reserve_code: "<%= @reserve_code %>",
                  stripeToken: res.id,
                  name: res.card.name,
                  email: res.email,
                  amount_base: <%= @amount %>,
                  amount_tip: (parseInt(amountProduct.val()) - <%= @amount %>),
                  amount_sb: parseInt(amountSb.val()),
                  amount_charity:parseInt(amountCharity.val())
                   }, // TODO - clean this up to only send a js plainObject with the necessary data
          success: function(data) { poll(data.guid, 60) },
          error: function(data) { showError(data.responseJSON.error) }
        });
      };

      StripeCheckout.open({
        key:         '<%= ENV["STRIPE_TEST_KEY_PUBLISHABLE"] %>', // TODO - replace with live key in production
        address:     true,
        amount:      (totalCalculator() * 100).toString(),
        currency:    'usd',
        name:        'Showboarder',
        description: "<%= @tickets.count %> tickets for $" + totalCalculator().toString() + ".00", //"<%= @tickets.count%> tickets totalCalculator() %>)",
        email: "<%= current_user.email %>",
        panelLabel:  'Checkout',
        token:       token
      });

      return false;
    });

    function showError(error) {
      var form = $('#payment-form');
      $('#payment-errors').html(error);
      $('#payment-errors').show();
      // $('#pay-button').show();
      // $('#spinner-button').hide();
    }

    function poll(guid, num_retries_left) {
      console.log("Polling...");
      if (num_retries_left == 0) {
        showError("This seems to be taking too long. Email <a href=\"contact@showboarder.com\">contact@showboarder.com</a> and reference sale <strong>" + guid );
        return;
      }
      $.get("/status/" + guid, function(data) {

        if (data.status === "finished") {
          window.location = "/confirm/" + guid;
        } else if (data.status === "errored") {
          showError(data.error)
        } else {
          setTimeout(function() { poll(guid, num_retries_left - 1) }, 500);
        }
      });
    }

  });
</script>

<div class="reg-content tickets-section-content">

  <form role="form">
    <div class="textbox-wrap">
      <label for="tip-sb" class="text-center">Tickets</label>
      <div class="input-group">
        <span class="input-group-addon "><i class="fa fa-dollar"></i></span><input name="amount-product" id="amount-product" type="text" class="form-control bfh-number" data-min="<%= @amount.to_i %>" value="1">
      </div>
    </div>

    <div class="textbox-wrap">
      <label for="tip" class="text-center">Showboarder/Charity Tip</label>
      <div class="input-group">
        <span class="input-group-addon "><i class="fa fa-dollar"></i></span><input name="tip" id="tip" type="text" class="form-control bfh-number" data-min="0" value="1">
      </div>
    </div>

    <div class="textbox-wrap">
      <label class="text-center">Tip Distribution</label>
      <label for="charity-slider"><span style"float:left;">To Showboarder</span><span style="float:right">To <a href="http://www.littlekidsrock.org/" target="_blank">Charity</a></span></label>
      <div class="row">
        <div class="col-xs-3">
          $<span id="charity-num" style="display:inline;"></span>
        </div>
        <div class="col-xs-6">
          <input type="range" min="0" max="100" value="20" id="charity-slider" step="1">
        </div>
        <div class="col-xs-3">
          $<span id="sb-num" style="display:inline;float:right;"></span>
        </div>
      </div>
    </div>
    <script>
      $(function(){
        var tipUpdate = function() {
          tip = $("#charity-slider").val();
          $('#charity-num').text(parseFloat(parseInt($('#tip').val()) * (1 - tip/100)).toFixed(2));
          $('#sb-num').text(parseFloat(parseInt($('#tip').val()) * (tip/100)).toFixed(2));
        }

        tipUpdate();

        $("#slider").slider()

        $("#charity-slider").change(function() {
          tipUpdate();
        })
      })
      
    </script>

    <div class="login-form-action clearfix">
      Total: <span id="amount-total"></span>
      <button id="stripeButton" class="btn btn-success pull-right green-btn">Purchase</button>
    </div>
  </form>
</div>

<div class="row">
  <div id="payment-errors" class="alert" style="<%= sale.errors.any? ? '' : 'display: none;' %>">
    <% sale.errors.full_messages.each do |msg| %>
      <span><%= msg %></span>
    <% end %>
  </div>
</div>