<div class="well payment-well">
  <%= form_tag object_path, :id => 'payment-form' do %>
    <% if coupon %>
      <input type="hidden" name="coupon_code" value="<%= coupon.code %>" />
    <% end %>
    
    <div class="row">
      <label class="control-label" for="email">Email </label>
      <% if user_signed_in? %>
        <input type="email" class="payment-email payment-input default-text" name="email" id="email" value="<%= current_user.email %>" disabled="disabled"/>
      <% else %>
        <input autofocus="true" type="email" class="payment-email payment-input default-text" name="email" id="email" placeholder="you@example.com"/>
      <% end %>
    </div>

    <% if !user_signed_in? || @cards.count == 0 || current_user.stripe_id == nil %>
      <%= render 'sales/no_cards_form' %>
      <%= render 'sales/payment_form_submit' %>      
    <% else %>
      <%= render 'sales/card_chooser_adder' %>
      <%= render 'sales/payment_form_submit' %>      
    <% end %>
  <% end %>

  <% if user_signed_in? && @cards.count > 0 %>
    <%= render 'sales/add_card' %>
  <% end %>
  
</div>
<div class="row">
  <div id="payment-errors" class="alert" style="<%= sale.errors.any? ? '' : 'display: none;' %>">
    <% sale.errors.full_messages.each do |msg| %>
      <span><%= msg %></span>
    <% end %>
  </div>
</div>

<script type="text/javascript" src="https://js.stripe.com/v2/"></script>
<script type="text/javascript">
  $(function(){
  
    Stripe.setPublishableKey('<%= Rails.configuration.stripe[:publishable_key] %>');

    $('#number').payment('formatCardNumber');
    $('#cvc').payment('formatCardCVC');
    $('#exp-month').payment('restrictNumeric');
    $('#exp-year').payment('restrictNumeric');
    $('#number').keyup(function(event) {
      var number = $('#number').val();
      var cardType = $.payment.cardType(number);
      var img = $('#card-image')[0];
      if (cardType === 'visa') {
        $('#cvc').attr("placeholder", "123");
        img.src = "<%= asset_path('visa.png') %>";
      } else if (cardType === 'mastercard') {
        $('#cvc').attr("placeholder", "123");
        img.src = "<%= asset_path('mastercard.png') %>";
      } else if (cardType === 'discover') {
        $('#cvc').attr("placeholder", "123");
        img.src = "<%= asset_path('discover.png') %>";
      } else if (cardType === 'amex') {
        $('#cvc').attr("placeholder", "1234");
        img.src = "<%= asset_path('amex.png') %>";
      } else if (cardType === 'dinersclub') {
        $('#cvc').attr("placeholder", "123");
        img.src = "<%= asset_path('diners.png') %>";
      } else if (cardType === 'maestro') {
        $('#cvc').attr("placeholder", "123");
        img.src = "<%= asset_path('maestro.png') %>";
      } else if (cardType === 'laser') {
        $('#cvc').attr("placeholder", "123");
        img.src = "<%= asset_path('laser.png') %>";
      } else {
        $('#cvc').attr("placeholder", "123");
        img.src = "<%= asset_path('credit.png')%>";
      }
    });

    $('#payment-form').submit(function(event) {
      var form = $(this);
      form.find('button').prop('disabled', true);
      Stripe.createToken(form, stripeResponseHandler);
      $('#pay-button').hide();
      $('#spinner-button').show();
      $('#pay-button').prop('disabled', false);
      return false;
    });

    function stripeResponseHandler(status, response) {
      var form = $('#payment-form');
      if (response.error) {
        showError(response.error.message);
      } else {
        var token = response.id;
        form.append($('<input type="hidden" name="stripeToken">').val(token));
        $.ajax({
          type: "POST",
          url: "<%= object_path %>",
          data: $('#payment-form').serialize(),
          success: function(data) { poll(data.guid, 60) },
          error: function(data) { showError(data.responseJSON.error) }
        });
      }
    }

    function showError(error) {
      var form = $('#payment-form');
      $('#payment-errors').html(error);
      $('#payment-errors').show();
      $('#pay-button').show();
      $('#spinner-button').hide();
    }

    function poll(guid, num_retries_left) {
      console.log("Polling...");
      if (num_retries_left == 0) {
        showError("This seems to be taking too long. Email <a href=\"contact@showboarder.com\">contact@showboarder.com</a> and reference sale <strong>" + guid );
        return;
      }
      $.get("/status/" + guid, function(data) {

        if (data.status === "finished") {
          window.location = "/confirm/" + guid;
        } else if (data.status === "errored") {
          showError(data.error)
        } else {
          setTimeout(function() { poll(guid, num_retries_left - 1) }, 500);
        }
      });
    }
  });
</script>
